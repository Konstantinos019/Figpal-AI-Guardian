// js/modules/sprite.js
// Final Sprite Assembly Logic & SVG Asset Library
(function () {
    'use strict';

    const FP = window.FigPal;
    FP.sprite = FP.sprite || {};

    // ─── SVG Asset Library (Inlined from Source) ─────────────────────
    const paths = {
        moss: "M38.8953 43.5C38.8953 48.9863 33.5684 53.5 27 53.5C20.4316 53.5 15.1047 48.9863 15.1047 43.5C15.1047 38.0137 20.4316 33.5 27 33.5C33.5684 33.5 38.8953 38.0137 38.8953 43.5Z",
        eyeLeft: "M1.46618 0C0.656428 0 0 0.656428 0 1.46618C1.50363e-08 2.27594 0.656428 2.93236 1.46618 2.93236C2.27593 2.93236 2.93236 2.27593 2.93236 1.46618C2.93236 0.65643 2.27593 4.07165e-06 1.46618 0Z",
        eyeRight: "M1.46618 0C2.27594 0 2.93236 0.656428 2.93236 1.46618C2.93236 2.27594 2.27594 2.93236 1.46618 2.93236C0.656431 2.93236 1.5036e-08 2.27593 0 1.46618C0 0.65643 0.656431 4.07165e-06 1.46618 0Z",
        top: "M18.6762 16.5814C9.89913 16.5417 4.25601 11.4482 1.548 7.30322C0.710142 6.02183 1.25202 4.34638 2.61694 3.65147C14.6714 -2.48816 20.4943 3.7691 22.7907 10.4616C25.0871 3.7691 30.91 -2.48816 42.9644 3.65147C44.3294 4.34638 44.8712 6.02183 44.0334 7.30322C41.0757 11.8301 34.6164 17.4886 24.3965 16.4577L24.6523 23.9062C24.6972 25.2151 23.6487 26.2994 22.3395 26.2994C21.2173 26.2994 20.2568 25.4945 20.0608 24.3903L18.6762 16.5814Z",
        stageTop: "M94.9051 6.14907C94.9051 13.6402 73.6596 19.713 47.4524 19.713C21.2452 19.713 2.16252e-05 13.6402 2.16252e-05 6.14907C2.16252e-05 -1.34213 -2.83378e-05 13.3191 2.3624e-05 0.114102C11.3397 0.114102 76.6621 -0.158508 94.9051 0.139016C94.9051 8.28317 94.9051 1.89924 94.9051 6.14907Z",
        stageBase: "M47.4523 24.0802C73.6595 24.0802 94.9047 18.6896 94.9047 12.0401C94.9047 5.39053 73.6595 0 47.4523 0C21.2451 0 0 5.39053 0 12.0401C0 18.6896 21.2451 24.0802 47.4523 24.0802Z",
        iconAnimal: "M14.3691 7.36144C14.338 6.89426 14.2198 6.45904 14.0294 6.05786L13.992 5.97874L13.9803 5.89234C13.8186 4.69946 13.5153 3.43581 13.1226 2.48585C12.9252 2.00825 12.717 1.64044 12.5155 1.40185C12.3595 1.21723 12.2461 1.15396 12.1786 1.13379L12.1266 1.125C11.6373 1.125 11.1777 1.35649 10.7687 1.71973C10.4112 2.03716 10.1258 2.42727 9.93663 2.75318L9.86118 2.88868L9.67878 3.23365L9.29208 3.18384C8.99958 3.14603 8.70056 3.12129 8.39711 3.11133L8.09163 3.1062C7.73651 3.1062 7.38873 3.12659 7.05161 3.1648L6.67076 3.20801L6.49132 2.86963C6.30566 2.5193 5.99423 2.0663 5.59264 1.70874C5.24078 1.3955 4.8533 1.18335 4.44273 1.13525L4.26549 1.125C4.21817 1.125 4.0818 1.15646 3.86558 1.41504C3.65773 1.66371 3.44351 2.04503 3.24083 2.53565C2.88803 3.38966 2.60636 4.48365 2.4359 5.54224L2.36924 5.99344L2.35973 6.06589L2.33189 6.13406C2.1755 6.51296 2.0783 6.92269 2.05157 7.36159C2.45333 7.26281 2.86385 7.18511 3.15298 7.18511C3.46359 7.18519 3.71548 7.43696 3.71548 7.74761C3.71548 8.05826 3.46359 8.31004 3.15298 8.31011C2.96485 8.31011 2.58374 8.38361 2.14571 8.49851C2.19367 8.70709 2.2582 8.91199 2.33829 9.11201C2.6694 8.97274 3.06941 8.85311 3.55581 8.77301L3.61294 8.76641C3.89743 8.74886 4.15449 8.94934 4.20181 9.23659C4.25216 9.54304 4.04465 9.83216 3.73819 9.88264C3.39961 9.93836 3.12064 10.0154 2.88963 10.1027C3.94217 11.5485 5.8877 12.5595 8.21103 12.5595L8.53773 12.553C10.7037 12.4636 12.5088 11.4913 13.515 10.126C13.3858 10.0659 13.2591 10.0137 13.1418 9.97346C13.0061 9.92689 12.9032 9.90319 12.8334 9.89434L12.7741 9.88991L12.717 9.88699C12.4333 9.85819 12.2116 9.61871 12.2116 9.32741C12.2118 9.01706 12.4637 8.76514 12.7741 8.76491L12.9601 8.77669C13.1471 8.79881 13.3356 8.85064 13.5065 8.90921C13.6941 8.97356 13.8861 9.05539 14.0703 9.14441C14.1565 8.93411 14.2254 8.71841 14.276 8.49859C13.9019 8.40034 13.5693 8.33224 13.3629 8.31454L13.2684 8.31011L13.2106 8.30719C12.9271 8.27824 12.7059 8.03876 12.7059 7.74761C12.7059 7.43696 12.9578 7.18511 13.2684 7.18511L13.4274 7.19171C13.698 7.21234 14.0365 7.27969 14.3691 7.36144ZM6.41914 6.49474C6.41914 6.82451 6.15177 7.09189 5.82196 7.09189C5.49215 7.09189 5.22478 6.82451 5.22478 6.49474C5.22478 6.16489 5.49215 5.89751 5.82196 5.89751C6.15177 5.89751 6.41914 6.16489 6.41914 6.49474ZM10.5994 7.09189C10.9293 7.09189 11.1966 6.82451 11.1966 6.49474C11.1966 6.16489 10.9293 5.89751 10.5994 5.89751C10.2696 5.89751 10.0023 6.16489 10.0023 6.49474C10.0023 6.82451 10.2696 7.09189 10.5994 7.09189ZM7.38858 7.81391C7.17716 7.58636 6.82076 7.57324 6.59317 7.78466C6.36575 7.99601 6.35273 8.35174 6.56387 8.57936C7.43381 9.51574 8.90441 9.55151 9.81873 8.65841L9.88031 8.59909C10.1023 8.38204 10.1061 8.02586 9.88908 7.80371C9.67196 7.58164 9.31586 7.57714 9.09363 7.79419L9.03288 7.85426C8.57088 8.30524 7.82808 8.28686 7.38858 7.81391Z",
        iconFood_1: "M11.9657 0.282574C12.1202 0.0132191 12.4638 -0.0797437 12.7333 0.0745613C13.0027 0.229009 13.0963 0.572644 12.9421 0.842142L7.64737 10.089C7.14322 10.9693 5.87294 10.9694 5.36879 10.089L0.0748735 0.842142L0.0485036 0.790871C-0.0676114 0.530471 0.0303011 0.219431 0.282879 0.0745613C0.535584 -0.0701287 0.853733 0.00247923 1.01969 0.234229L1.05046 0.282574L6.34514 9.53015C6.41714 9.6557 6.59902 9.6557 6.67109 9.53015L11.9657 0.282574Z",
        iconFood_2: "M8.25645 0C10.8708 7.5e-06 12.6547 0.432383 13.8427 0.931643L14.0587 1.02539C14.5448 1.24622 14.9161 1.47357 15.191 1.67432L15.402 1.83764C15.4645 1.88902 15.5194 1.93748 15.5675 1.98194L15.6898 2.10205L15.736 2.15039L15.7389 2.15405L15.7623 2.17969L15.8209 2.24561L15.829 2.26319C16.35 2.93204 16.353 3.90713 15.84 4.57691L15.7264 4.71094C15.0941 5.38677 14.0846 5.41373 13.423 4.79004L13.4134 4.78125L13.4047 4.77173L13.3629 4.72852L13.3644 4.73071L13.2919 4.67285C13.2167 4.61803 13.0773 4.52591 12.8583 4.4187L12.6115 4.30737C11.8809 4.00033 10.5255 3.62623 8.25645 3.62622C5.98996 3.62622 4.54517 4.00016 3.71765 4.32349C3.61819 4.36233 3.57727 4.36959 3.42982 4.43921C3.28741 4.50646 3.06177 4.62651 2.70764 4.85376C2.20982 5.17319 1.71593 5.22518 1.29627 5.12768C0.897703 5.03504 0.590015 4.81405 0.412963 4.61426L0.400513 4.60034L0.389525 4.5857C-0.162768 3.8724 -0.123535 2.82269 0.48035 2.15991L0.494998 2.12696L0.587285 2.04932C0.590308 2.04651 0.5939 2.04311 0.597538 2.03979L0.642215 2.00024L0.765995 1.89697L0.937378 1.76807C1.0024 1.72157 1.07586 1.6718 1.15711 1.61939L1.42737 1.45459C1.7239 1.28342 2.09892 1.09643 2.56189 0.915525L2.80139 0.825435C4.0321 0.379882 5.80308 0 8.25645 0ZM8.25645 1.125C5.92076 1.125 4.28044 1.48595 3.18372 1.88306L2.97132 1.96289C2.56175 2.12292 2.23792 2.28553 1.98987 2.42871L1.76648 2.56494C1.70019 2.60771 1.64232 2.64772 1.59217 2.68359L1.46473 2.77881L1.38196 2.84839L1.35633 2.87036L1.35559 2.87109L1.35413 2.87183L1.34974 2.87549C1.34811 2.87707 1.34691 2.8799 1.34461 2.88208L1.34021 2.88501C1.33846 2.88668 1.33687 2.8885 1.33509 2.89013C1.08815 3.133 1.04931 3.57894 1.2655 3.87818C1.31095 3.92401 1.41356 4.00009 1.55042 4.03198C1.67728 4.06147 1.8606 4.06139 2.10046 3.90747C2.48389 3.66142 2.75267 3.51507 2.95008 3.42188C3.14143 3.33154 3.28582 3.28407 3.30823 3.27539C4.27877 2.89619 5.86402 2.50122 8.25645 2.50122C10.6494 2.50123 12.1568 2.89605 13.0472 3.27026L13.3527 3.40869C13.6303 3.54458 13.8267 3.66992 13.9555 3.76391L14.0638 3.84815C14.0926 3.87199 14.1136 3.89175 14.1283 3.90527L14.1371 3.91333L14.1385 3.91259L14.1971 3.97265C14.4048 4.16664 14.6981 4.16335 14.9047 3.94262L14.9486 3.89063C15.1411 3.63631 15.1489 3.2472 14.9632 2.98169L14.9208 2.92676L14.92 2.92602L14.9054 2.90991L14.8812 2.88354L14.8036 2.80811C14.7717 2.77861 14.733 2.74472 14.6872 2.70703L14.5275 2.58325C14.3456 2.45048 14.0958 2.29247 13.765 2.13062L13.4068 1.96875C12.3786 1.5366 10.7467 1.12501 8.25645 1.125Z",
        iconObject: "M7.31483 0C7.54522 1.8683e-05 7.7716 0.0615347 7.97035 0.177979C8.14416 0.279844 8.2914 0.420699 8.40101 0.588867L8.44569 0.662842L8.44789 0.665771L7.99452 0.914795L7.97328 0.927246L8.44789 0.665771C9.09119 1.83224 9.62085 3.05883 10.0299 4.32642C10.0474 4.37752 10.0807 4.42213 10.1244 4.45386C10.168 4.48544 10.22 4.50347 10.2738 4.50439H10.2797L10.265 5.06616V5.07861L10.2797 4.50439C11.3804 4.53224 12.4777 4.64121 13.5624 4.83105C14.5647 5.00694 15.0068 6.20921 14.245 6.95435C13.5282 7.65552 12.7687 8.31127 11.9708 8.91797L11.6266 9.17505H11.6259C11.5422 9.23625 11.5186 9.32934 11.5446 9.40796L11.6691 9.79395C11.9101 10.5687 12.1052 11.357 12.2543 12.1545L12.3253 12.5544V12.5559L11.7921 12.6431L11.5856 12.6775L12.3253 12.5559C12.3606 12.7708 12.3931 12.9869 12.4227 13.2041L12.4235 13.2063C12.5603 14.2397 11.5042 14.8888 10.6349 14.5159L10.5514 14.4771C9.48093 13.9286 8.45754 13.2927 7.49134 12.5764C7.44007 12.5391 7.37822 12.5193 7.31483 12.5193C7.25252 12.5193 7.19179 12.5384 7.14125 12.5742L6.77577 12.8394C5.91692 13.449 5.01506 13.9964 4.07753 14.4771C3.19348 14.9301 2.06492 14.2728 2.20619 13.2063V13.2056L2.27723 12.7222C2.45536 11.5974 2.72547 10.489 3.08509 9.40796L3.09462 9.34717C3.0948 9.28523 3.06547 9.22133 3.00233 9.17505L3.33851 8.71655L3.33485 8.72095L3.00233 9.17432L2.69838 8.948C1.99461 8.41425 1.31999 7.84292 0.677623 7.23633C0.578439 7.14334 0.480488 7.04867 0.38319 6.95288L0.383922 6.95215C-0.376514 6.20642 0.0664561 5.00679 1.06654 4.83105H1.06727C2.15154 4.6424 3.24836 4.53336 4.34852 4.50439L4.3954 4.49927C4.50002 4.48029 4.57257 4.40948 4.59608 4.33667L4.7162 3.97559C5.00369 3.13582 5.34478 2.31479 5.73719 1.51831V1.51758C5.87916 1.23048 6.02728 0.947089 6.18104 0.667236L6.18324 0.662842C6.29593 0.461651 6.46058 0.294413 6.65931 0.177979C6.85811 0.0615181 7.08438 0 7.31483 0ZM7.31483 1.125C7.2843 1.125 7.25401 1.133 7.22767 1.14844C7.20131 1.16391 7.17947 1.18649 7.16468 1.21289C7.01945 1.47737 6.87981 1.74522 6.74574 2.01636C6.3216 2.87729 5.96107 3.76811 5.66688 4.68164C5.48526 5.2448 4.95819 5.6126 4.38002 5.62866L4.36097 4.94238L4.3683 5.2251L4.38002 5.62866H4.37928C3.33371 5.65615 2.29109 5.7592 1.26063 5.93848L1.26136 5.93921C1.17505 5.95437 1.14301 6.0003 1.13246 6.03223C1.12645 6.05039 1.12577 6.06812 1.12953 6.08423C1.13297 6.09877 1.14263 6.12213 1.17128 6.15015L1.17201 6.15161L1.4474 6.41528L1.44886 6.41675C2.14978 7.07873 2.89105 7.6969 3.6681 8.26758H3.66737C4.10439 8.5879 4.31 9.13337 4.18226 9.65771L4.15223 9.76245C3.76356 10.9308 3.48504 12.1332 3.32093 13.3535L3.32167 13.3542C3.31743 13.3863 3.32264 13.407 3.32972 13.4216C3.33782 13.4384 3.3531 13.4567 3.3766 13.4722C3.42251 13.5024 3.48979 13.5143 3.56483 13.4758C4.58134 12.9546 5.55321 12.3506 6.47108 11.6704L6.8058 12.1223H6.80653L6.47108 11.6704L6.47474 11.6682C6.7187 11.4901 7.0129 11.3943 7.31483 11.3943C7.61676 11.3943 7.91098 11.4902 8.15492 11.6682L8.15858 11.6704L7.82313 12.1223L7.81654 12.1304L8.15858 11.6704C9.07612 12.3509 10.0481 12.9549 11.0648 13.4758L11.1198 13.4956C11.1721 13.5069 11.2184 13.495 11.2531 13.4722C11.2766 13.4567 11.2918 13.4384 11.2999 13.4216C11.3035 13.4144 11.3062 13.4054 11.308 13.3945V13.3535C11.2798 13.1474 11.2491 12.9425 11.2157 12.739L11.1491 12.3611C11.008 11.6065 10.8227 10.8609 10.5946 10.1279L10.4767 9.76245C10.2928 9.20812 10.4941 8.60911 10.9623 8.26685C11.8433 7.62122 12.6775 6.91402 13.4584 6.15015L13.4884 6.11206C13.4948 6.10092 13.4984 6.09154 13.5001 6.08423C13.504 6.06805 13.5031 6.05031 13.4972 6.03223C13.4894 6.00852 13.4693 5.97688 13.4232 5.95605L13.3683 5.93921C12.3383 5.75894 11.2964 5.6551 10.2511 5.62866V5.62793C10.0032 5.62306 9.76181 5.55278 9.55165 5.42358L9.46302 5.36426L9.3788 5.29834C9.2168 5.16042 9.08885 4.98686 9.00453 4.7915L8.96571 4.69189L8.96278 4.68164L9.47547 4.51611L9.49672 4.50952L8.96278 4.68164C8.57568 3.47995 8.07368 2.31764 7.46424 1.21216C7.44932 1.18583 7.42742 1.16377 7.40126 1.14844C7.37497 1.13309 7.34514 1.12502 7.31483 1.125Z",
        iconFigma: "M0 2.83391C0 3.76349 0.447585 4.58854 1.139 5.1053C0.447585 5.62207 0 6.4471 0 7.37672C0 8.30627 0.447585 9.13135 1.139 9.6481C0.447585 10.1648 0 10.9899 0 11.9195C0 13.4846 1.26878 14.7534 2.8339 14.7534C4.399 14.7534 5.66777 13.4846 5.66777 11.9195V10.2106V9.6481V9.6376C6.1429 9.99722 6.73487 10.2106 7.37672 10.2106C8.94182 10.2106 10.2106 8.94182 10.2106 7.37672C10.2106 6.4471 9.763 5.62207 9.07165 5.1053C9.763 4.58854 10.2106 3.76349 10.2106 2.83391C10.2106 1.26878 8.94182 0 7.37672 0H5.66777H5.10527H4.54277H2.8339C1.26878 0 0 1.26878 0 2.83391ZM7.37672 4.5428C8.32052 4.5428 9.0856 3.77771 9.0856 2.83391C9.0856 1.8901 8.32052 1.125 7.37672 1.125H5.66777V4.5428H7.3753H7.37672ZM4.54277 7.37672V5.6678S2.8339 5.6678 1.125 6.43292 1.125 7.37672C1.125 8.32052 1.8901 9.0856 2.8339 9.0856H4.54277V7.37672ZM5.66777 7.37672C5.66777 8.32052 6.43292 9.0856 7.37672 9.0856C8.32052 9.0856 9.0856 8.32052 9.0856 7.37672C9.0856 6.43292 8.32052 5.6678 7.37672 5.6678H7.3756C6.43232 5.66841 5.66777 6.4333 5.66777 7.37672ZM2.8339 10.2106H4.54277V11.9195C4.54277 12.8633 3.7777 13.6284 2.8339 13.6284C1.8901 13.6284 1.125 12.8633 1.125 11.9195C1.125 10.9757 1.8901 10.2106 2.8339 10.2106ZM4.54277 4.5428H2.8339C1.8901 4.5428 1.125 3.77771 1.125 2.83391C1.125 1.8901 1.8901 1.125 2.8339 1.125H4.54277V4.5428Z",
        iconDice: "M3.2474 0.775925L9.04299 2.32885C9.44304 2.43602 9.7121 2.84607 9.60493 3.24612C9.49776 3.64617 9.08771 3.91523 8.68766 3.80806L2.89207 2.25513C2.49202 2.14796 2.22296 1.73791 2.33013 1.33786C2.4373 0.93781 2.84735 0.66875 3.2474 0.775925ZM6.30706 8.19544C5.90701 8.08827 5.63795 7.67822 5.74512 7.27817C5.85229 6.87812 6.26234 6.60906 6.66239 6.71623L12.4579 8.26916C12.858 8.37633 13.127 8.78638 13.0199 9.18643C12.9127 9.58648 12.5027 9.85554 12.1026 9.74837L6.30706 8.19544ZM1.33786 9.18643C1.73791 9.07926 2.00697 8.66921 1.8998 8.26916L0.346875 2.47357C0.239701 2.07352 -0.17035 1.80446 -0.5704 1.91163C-0.97045 2.0188 -1.23951 2.42885 -1.13234 2.8289L0.346875 8.62449C0.454049 9.02454 0.864099 9.2936 1.26415 9.18643L1.33786 9.18643ZM12.1026 1.91163C12.5027 1.80446 12.9127 2.07352 13.0199 2.47357L14.4991 8.26916C14.6063 8.66921 14.3372 9.07926 13.9372 9.18643C13.5371 9.2936 13.1271 9.02454 13.0199 8.62449L11.5407 2.8289C11.4335 2.42885 11.7026 2.0188 12.1026 1.91163Z"
    };

    // ─── Assembly Logic (Restored) ─────────────────────
    FP.sprite.assemble = function (options = {}) {
        const category = options.category || "Object";
        const subType = options.subType || "Rock";
        const colorName = options.colorName || "Gray";
        const accessory = options.accessory || "";
        const isFlipped = options.flipped || false;

        const palsPath = "media/pals";
        let layersHtml = "";

        let bodyUrl;
        if (options.customBodyUrl) {
            bodyUrl = options.customBodyUrl;
        } else {
            const variantFile = `Color=${colorName}.svg`;
            bodyUrl = `${palsPath}/${category}/${subType}/${variantFile}`;
        }

        const fallbackRock = `media/pals/Object/Rock/Color=${colorName}.svg`;
        const errLog = `this.onerror=null; this.src='${fallbackRock}';`;

        layersHtml += `<img src="${bodyUrl}" onerror="${errLog}" style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; z-index:1;">`;

        if (accessory && accessory !== "None") {
            let position = options.accessoryPosition;
            if (!position) {
                position = "Top";
                const positionOverrides = {
                    "Snake": "Left", "Duck": "Left", "Caterpillar": "Left", "Bird": "Left", "Capybara": "Left",
                    "Cat": "Bottom", "Dog": "Bottom", "Rodent": "Bottom", "Snail": "Right"
                };
                if (positionOverrides[subType]) position = positionOverrides[subType];
            }
            const accessoryUrl = `media/Accessories/${position}/${accessory}.svg`;
            layersHtml += `<img src="${accessoryUrl}" onerror="${errLog}" style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; z-index:5;">`;
        }

        const flipStyle = isFlipped ? 'transform: scaleX(-1);' : '';
        return `<div class="figpal-sprite-container" style="position:relative; width:100%; height:100%; ${flipStyle}">${layersHtml}</div>`;
    };

    FP.sprite.getIcon = function (name, color = "#1A1A1A") {
        const iconPath = paths["icon" + name.charAt(0).toUpperCase() + name.slice(1)];
        if (!iconPath) return "";

        let viewBox = "0 0 16 16";
        if (name === 'animal') viewBox = "0 0 16.42 13.68";
        if (name === 'food_1') viewBox = "0 0 13.02 10.75";
        if (name === 'food_2') viewBox = "0 0 16.22 5.24";
        if (name === 'object') viewBox = "0 0 14.63 14.62";
        if (name === 'figma') viewBox = "0 0 10.21 14.75";
        if (name === 'dice') viewBox = "0 0 10.35 10.35";

        return `<svg viewBox="${viewBox}" fill="none" xmlns="http://www.w3.org/2000/svg" class="figpal-icon-svg"><path d="${iconPath}" fill="${color}" /></svg>`;
    };

    FP.sprite.getIconHTML = function (name) {
        const url = `media/Icons/${encodeURIComponent(name)}.svg`;
        return `<div class="figpal-icon-mask" style="-webkit-mask-image: url('${url}'); mask-image: url('${url}');"></div>`;
    };

    FP.sprite.getStage = function (category = "Object") {
        const stageUrl = (category === "Custom") ? `media/stage/Custom.svg` : `media/stage/Category=${category}.svg`;
        return `<img src="${stageUrl}" class="figpal-stage-svg" style="width:100%; height:100%; display:block; object-fit:contain;">`;
    };

    console.log('FigPal: Sprite module initialized (Strict Restoration)');
})();
